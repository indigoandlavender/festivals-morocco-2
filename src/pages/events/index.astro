---
import Base from '../../layouts/Base.astro';
import {
  getEvents,
  getCities,
  getTraditions,
  getEventTypes,
  formatDateRange,
  formatLocation,
  EventType,
  EventTypeLabels,
  TraditionCategory,
  TraditionCategoryLabels,
  MUSIC_TRADITIONS
} from '../../lib/api';

const url = Astro.url;
const cityFilter = url.searchParams.get('city');
const traditionFilter = url.searchParams.get('tradition');
const typeFilter = url.searchParams.get('type') as EventType | null;
const categoryFilter = url.searchParams.get('category') as TraditionCategory | null;
const query = url.searchParams.get('q');

let events = getEvents();
const cities = getCities();
const traditions = getTraditions();
const eventTypes = getEventTypes();

// Apply filters
if (cityFilter) {
  events = events.filter(e => e.location.city_slug === cityFilter);
}

if (traditionFilter) {
  events = events.filter(e => e.traditions.includes(traditionFilter));
}

if (typeFilter) {
  events = events.filter(e => e.event_type === typeFilter);
}

if (categoryFilter) {
  events = events.filter(e =>
    e.traditions.some(tid => {
      const tradition = MUSIC_TRADITIONS[tid];
      return tradition && tradition.category === categoryFilter;
    })
  );
}

if (query) {
  const q = query.toLowerCase();
  events = events.filter(e =>
    e.name.toLowerCase().includes(q) ||
    (e.location.city && e.location.city.toLowerCase().includes(q)) ||
    e.location.region.toLowerCase().includes(q) ||
    e.traditions.some(tid => {
      const tradition = MUSIC_TRADITIONS[tid];
      return tradition && tradition.name.toLowerCase().includes(q);
    }) ||
    e.artists.some(a => a.toLowerCase().includes(q))
  );
}

// Sort by cultural weight then date
events.sort((a, b) => {
  if (a.is_featured && !b.is_featured) return -1;
  if (!a.is_featured && b.is_featured) return 1;
  if (a.cultural_weight !== b.cultural_weight) return b.cultural_weight - a.cultural_weight;
  return (a.timing.gregorian_start || '').localeCompare(b.timing.gregorian_start || '');
});

// Group traditions by category for the filter
const rootedTraditions = traditions.filter(t => t.category === TraditionCategory.ROOTED);
const hybridTraditions = traditions.filter(t => t.category === TraditionCategory.HYBRID);
const importedTraditions = traditions.filter(t => t.category === TraditionCategory.IMPORTED);

const hasFilters = cityFilter || traditionFilter || typeFilter || categoryFilter || query;
---

<Base title="Events - Festivals in Morocco">
  <div class="page-header">
    <h1>Events</h1>
    <p class="subtitle">{events.length} music events in Morocco</p>
  </div>

  <div class="filters">
    <form method="GET" action="/events" class="search-inline">
      <input
        type="search"
        name="q"
        placeholder="Search events, artists, places..."
        value={query || ''}
        autocomplete="off"
      >
      <button type="submit">Search</button>
      <a href="/search" class="advanced-link">Advanced search</a>
    </form>

    <div class="filter-row">
      <select name="type" id="type-filter">
        <option value="">All Types</option>
        {eventTypes.map(et => (
          <option value={et.type} selected={typeFilter === et.type}>
            {et.label} ({et.count})
          </option>
        ))}
      </select>

      <select name="category" id="category-filter">
        <option value="">All Tradition Categories</option>
        <option value={TraditionCategory.ROOTED} selected={categoryFilter === TraditionCategory.ROOTED}>
          Rooted Traditions
        </option>
        <option value={TraditionCategory.HYBRID} selected={categoryFilter === TraditionCategory.HYBRID}>
          Hybrid / Contemporary
        </option>
        <option value={TraditionCategory.IMPORTED} selected={categoryFilter === TraditionCategory.IMPORTED}>
          International
        </option>
      </select>

      <select name="tradition" id="tradition-filter">
        <option value="">All Traditions</option>
        {rootedTraditions.length > 0 && (
          <optgroup label="Rooted">
            {rootedTraditions.map(t => (
              <option value={t.id} selected={traditionFilter === t.id}>
                {t.name} {t.sacred ? '●' : ''} ({t.count})
              </option>
            ))}
          </optgroup>
        )}
        {hybridTraditions.length > 0 && (
          <optgroup label="Hybrid">
            {hybridTraditions.map(t => (
              <option value={t.id} selected={traditionFilter === t.id}>
                {t.name} ({t.count})
              </option>
            ))}
          </optgroup>
        )}
        {importedTraditions.length > 0 && (
          <optgroup label="International">
            {importedTraditions.map(t => (
              <option value={t.id} selected={traditionFilter === t.id}>
                {t.name} ({t.count})
              </option>
            ))}
          </optgroup>
        )}
      </select>

      <select name="city" id="city-filter">
        <option value="">All Cities</option>
        {cities.map(city => (
          <option value={city.slug} selected={cityFilter === city.slug}>
            {city.name} ({city.count})
          </option>
        ))}
      </select>
    </div>

    {hasFilters && (
      <a href="/events" class="clear-filters">Clear all filters</a>
    )}
  </div>

  <div class="events-grid">
    {events.map(event => {
      const eventTraditions = event.traditions
        .map(tid => MUSIC_TRADITIONS[tid])
        .filter(Boolean);
      const hasSacred = eventTraditions.some(t => t.sacred);

      return (
        <a href={`/events/${event.slug}`} class="event-card" data-weight={event.cultural_weight}>
          <div class="event-header">
            <span class="event-date">{formatDateRange(event.timing)}</span>
            <div class="event-badges">
              {event.is_verified && <span class="verified" title="Verified">✓</span>}
              {hasSacred && <span class="sacred" title="Features sacred tradition">◆</span>}
            </div>
          </div>

          <h2>{event.name}</h2>
          <p class="event-location">{formatLocation(event.location)}</p>

          <div class="event-traditions">
            {eventTraditions.slice(0, 3).map(tradition => (
              <span
                class="tradition-tag"
                data-category={tradition.category}
                data-sacred={tradition.sacred}
              >
                {tradition.name}
              </span>
            ))}
            {eventTraditions.length > 3 && (
              <span class="tradition-more">+{eventTraditions.length - 3}</span>
            )}
          </div>

          <div class="event-footer">
            <span class="event-type">{EventTypeLabels[event.event_type]}</span>
            <span class="event-status" data-status={event.status}>{event.status}</span>
          </div>
        </a>
      );
    })}
  </div>

  {events.length === 0 && (
    <div class="no-results">
      <p>No events found matching your criteria.</p>
      <a href="/events" class="btn">View all events</a>
    </div>
  )}

  <div class="legend">
    <h3>Legend</h3>
    <div class="legend-items">
      <span class="legend-item"><span class="verified">✓</span> Verified event</span>
      <span class="legend-item"><span class="sacred">◆</span> Features sacred tradition</span>
      <span class="legend-item"><span class="tradition-tag" data-category="rooted">Rooted</span> Ancestral tradition</span>
      <span class="legend-item"><span class="tradition-tag" data-category="hybrid">Hybrid</span> Moroccan contemporary</span>
      <span class="legend-item"><span class="tradition-tag" data-category="imported">Imported</span> International form</span>
    </div>
  </div>
</Base>

<script>
  const typeSelect = document.getElementById('type-filter') as HTMLSelectElement;
  const categorySelect = document.getElementById('category-filter') as HTMLSelectElement;
  const traditionSelect = document.getElementById('tradition-filter') as HTMLSelectElement;
  const citySelect = document.getElementById('city-filter') as HTMLSelectElement;

  function applyFilters() {
    const params = new URLSearchParams(window.location.search);

    if (typeSelect.value) params.set('type', typeSelect.value);
    else params.delete('type');

    if (categorySelect.value) params.set('category', categorySelect.value);
    else params.delete('category');

    if (traditionSelect.value) params.set('tradition', traditionSelect.value);
    else params.delete('tradition');

    if (citySelect.value) params.set('city', citySelect.value);
    else params.delete('city');

    const queryString = params.toString();
    window.location.href = '/events' + (queryString ? '?' + queryString : '');
  }

  typeSelect?.addEventListener('change', applyFilters);
  categorySelect?.addEventListener('change', applyFilters);
  traditionSelect?.addEventListener('change', applyFilters);
  citySelect?.addEventListener('change', applyFilters);
</script>

<style>
  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: var(--text-muted);
  }

  .filters {
    margin-bottom: 2rem;
  }

  .search-inline {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .search-inline input {
    flex: 1;
    max-width: 400px;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-card);
    color: var(--text);
    font-size: 0.95rem;
  }

  .search-inline input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .search-inline button {
    padding: 0.75rem 1.25rem;
    background: var(--accent);
    color: var(--accent-contrast);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  .advanced-link {
    font-size: 0.8rem;
    color: var(--text-muted);
    align-self: center;
  }

  .advanced-link:hover {
    color: var(--accent);
  }

  .filter-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .filter-row select {
    padding: 0.625rem 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-card);
    color: var(--text);
    font-size: 0.9rem;
    cursor: pointer;
    min-width: 160px;
  }

  .filter-row select:focus {
    outline: none;
    border-color: var(--accent);
  }

  .clear-filters {
    display: inline-block;
    margin-top: 0.75rem;
    color: var(--accent);
    font-size: 0.875rem;
  }

  .events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }

  .event-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    transition: border-color 0.2s, transform 0.2s;
  }

  .event-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
  }

  .event-card[data-weight="4"],
  .event-card[data-weight="5"] {
    border-left: 3px solid var(--accent);
  }

  .event-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .event-date {
    color: var(--accent);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .event-badges {
    display: flex;
    gap: 0.375rem;
  }

  .verified {
    background: var(--accent);
    color: var(--accent-contrast);
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
  }

  .sacred {
    background: var(--sacred);
    color: var(--accent-contrast);
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
  }

  .event-card h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }

  .event-location {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
  }

  .event-traditions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 1rem;
  }

  .tradition-tag {
    padding: 0.25rem 0.625rem;
    border-radius: 100px;
    font-size: 0.75rem;
  }

  .tradition-tag[data-category="rooted"] {
    background: var(--category-rooted-bg);
    color: var(--category-rooted);
  }

  .tradition-tag[data-category="hybrid"] {
    background: var(--category-hybrid-bg);
    color: var(--category-hybrid);
  }

  .tradition-tag[data-category="imported"] {
    background: var(--category-imported-bg);
    color: var(--category-imported);
  }

  .tradition-tag[data-sacred="true"] {
    border: 1px solid var(--sacred);
  }

  .tradition-more {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .event-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
  }

  .event-type {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .event-status {
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    text-transform: capitalize;
  }

  .event-status[data-status="confirmed"] {
    background: var(--status-confirmed-bg);
    color: var(--status-confirmed);
  }

  .event-status[data-status="announced"] {
    background: var(--status-announced-bg);
    color: var(--status-announced);
  }

  .event-status[data-status="tentative"] {
    background: var(--status-tentative-bg);
    color: var(--status-tentative);
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
  }

  .no-results .btn {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    background: var(--accent);
    color: var(--accent-contrast);
    border-radius: 8px;
    font-weight: 600;
  }

  .legend {
    margin-top: 3rem;
    padding: 1.5rem;
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .legend h3 {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-muted);
  }

  .legend-items {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  @media (max-width: 640px) {
    .page-header h1 {
      font-size: 2rem;
    }

    .filter-row {
      flex-direction: column;
    }

    .filter-row select {
      width: 100%;
    }

    .events-grid {
      grid-template-columns: 1fr;
    }

    .legend-items {
      flex-direction: column;
      gap: 0.75rem;
    }
  }
</style>
